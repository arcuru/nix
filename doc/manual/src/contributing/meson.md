# Meson Build System

Nix is now experimentally using [Meson](https://mesonbuild.com/) for a local build system.

## Getting Started

Use the [Hacking Guide](hacking.md) to enter a devshell. It contains all the dependencies needed for the Meson build system.

## Using Meson

Meson does out of source builds, and must be given the path for some of the dependencies. From the root of the repo once you're in the devshell, run the following:

```console
$ meson setup -D rapidcheck_dir=$RAPIDCHECK_DIR -D aws_sdk_cpp_include_dir=$AWS_SDK_INCLUDEDIR -D aws_sdk_cpp_lib_dir=$AWS_SDK_LIBRARYDIR builddir
$ cd builddir/
$ meson compile
```

All of the following commands need to be run in the build directory.

## Unit Tests

The unit tests can be run by themselves with the following:

```console
$ meson test --suite unit
```

## Functional Tests

The functional tests require the nix build to be installed into the local environment, otherwise they will use the system nix.

They still depend on a few files generated by the autotools build system, so you need to configure that build system and build a few files before running the functional tests.

```console
$ # From the repo root, run:
$ ./bootstrap.sh
$ ./configure $configureFlags --prefix=$(pwd)/outputs/out
$ make tests/common/vars-and-functions.sh
$ make tests/config.nix
$ cd builddir/
$ meson install --destdir ../outputs/out
$ meson test --suite functional
```
